class AddonProduct extends HTMLElement{constructor(){super(),this.productId=this.dataset.productId,this.cart=document.querySelector("cart-drawer"),this.cartNote=this.querySelector("cart-note"),this.input=this.querySelector('input[type="checkbox"]'),this.note=this.querySelector('[name="note"]'),this.note.addEventListener("change",()=>{this.checkIsValid()})}connectedCallback(){this.input.addEventListener("change",this.onChange.bind(this)),this.checkProductInCart()}onChange(e){e.currentTarget.checked?(this.addProduct(),this.cartNote.querySelector("textarea").focus(),this.productAdded=!0):(this.removeProduct(),this.productAdded=!1),this.checkIsValid()}checkProductInCart(){getCart().items.find(i=>i.variant_id==this.productId)&&(this.input.checked=!0,this.productAdded=!0)}trackingCdpEvent(id,quantity){if(window.cdpTracking){let item=window.cdpTracking.getCart().items.find(i=>i.variant_id==id);item&&(item.quantity=quantity,window.cdpTracking.addToCart([item]))}}addProduct(){if(!getCart().items.find(i=>i.variant_id==this.productId)){const config=fetchConfig("javascript");config.headers["X-Requested-With"]="XMLHttpRequest",delete config.headers["Content-Type"];const formData=new FormData;formData.append("id",this.productId),formData.append("quantity",1),formData.append("sections",this.cart.getSectionsToRender().map(section=>section.id)),formData.append("sections_url",window.location.pathname),config.body=formData,fetch(`${routes.cart_add_url}`,config).then(response=>response.json()).then(response=>{this.cart.renderContents(response,!0,()=>{publish("levents:addToCart",{data:{items:[{id:this.productId,quantity:1}]}})})}).catch(e=>{console.error(e)})}}removeProduct(){let line=getCart().items.findIndex(i=>i.variant_id==this.productId);line!=-1&&(line=line+1,this.cart.querySelector("cart-drawer-items").updateQuantity(line,0))}checkIsValid(){let noteValue=this.note.value.trim();return this.productAdded&&!noteValue?(this.note.classList.add("is-valid"),this.querySelector("#note-error").textContent="B\u1EA1n ch\u01B0a nh\u1EADp n\u1ED9i dung cho qu\xE0 t\u1EB7ng c\u1EE7a b\u1EA1n",!1):(this.note.classList.remove("is-valid"),this.querySelector("#note-error").textContent="",!0)}}customElements.define("addon-product",AddonProduct);class CheckoutVoucherList extends HTMLElement{constructor(){super(),this.cartId=this.dataset.cartId,this.voucherItems=this.querySelectorAll(".voucher-item"),this.cart=document.querySelector("cart-drawer"),this.voucherTemplate=this.querySelector("template"),this.customerVoucher=this.querySelector(".customer-voucher-list"),this.discountQuery=`
    mutation cartDiscountCodesUpdate($cartId: ID!, $discountCodes: [String!]) {
      cartDiscountCodesUpdate(cartId: $cartId, discountCodes: $discountCodes) {
        cart {
          buyerIdentity{
            email,
            phone,
            deliveryAddressPreferences {
              ... on MailingAddress {
                  address1
                  address2
              }
          }
          }
          cost {
            totalAmount {
              amount
              currencyCode
            }
            totalAmountEstimated
          }
          discountCodes {
            applicable
            code
          }
          discountAllocations {
            discountedAmount {
              amount
              currencyCode
            }
          }
          id
          totalQuantity
        }
        userErrors {
          field
          message
        }
      }
    }
      `,this.renderCustomerVouchers()}connectedCallback(){console.log(this.customerId),this.customerId?this.getVoucherList():this.initEvents()}get customerId(){return this.dataset.customerId}initEvents(){this.voucherItems.forEach(e=>e.addEventListener("click",this.onVoucherSelect.bind(this))),getCurrentCart(!1,this.checkVoucher.bind(this)),this.classList.remove("loading")}getVoucherList(){const url=`${window.apiUrl}/joy-avada-io/integrate/customer/rewards/${this.customerId}`;fetch(url).then(res=>res.json()).then(res=>{res.success&&this.renderCustomerVouchers(res.data)}).finally(()=>{this.initEvents()})}onVoucherSelect(e){const code=e.currentTarget.querySelector("input").value;this.voucherItems.forEach(voucher2=>{voucher2.classList.remove("selected"),e.currentTarget.classList.add("selected")}),getCurrentCart(!1,cart=>{this.applyVoucher(cart,code)})}applyVoucher(cart,code){if(!cart)return;const discountCodes=cart.cart_level_discount_applications.map(item=>item.title);discountCodes.push(code);const variables={cartId:`gid://shopify/Cart/${cart.token}`,discountCodes};makeGraphQLRequest({query:this.discountQuery,variables},()=>{this.cart.querySelector("cart-drawer-items").onCartUpdate()})}removeVoucher(cart,callback){if(!cart)return;const discountCodes=[],variables={cartId:`gid://shopify/Cart/${cart.token}`,discountCodes};makeGraphQLRequest({query:this.discountQuery,variables})}activeItems(res,selected){if(res.data&&res.data.cartDiscountCodesUpdate){const{discountCodes}=res.data.cartDiscountCodesUpdate.cart;discountCodes&&discountCodes.map(item=>{item.applicable&&this.voucherItems.forEach(voucher2=>{voucher2.querySelector("input").value==item.code&&(voucher2.classList.remove("disabled"),selected&&(voucher2.classList.add("selected"),voucher2.querySelector("input").checked=!0))})})}}checkVoucher(cart){if(!cart)return;const discountCodes=Array.from(this.voucherItems).map(item=>item.querySelector("input").value).filter(Boolean);discountCodes.forEach((code,index)=>{const variables={cartId:`gid://shopify/Cart/${cart.token}`,discountCodes:[code.trim()]},currentCodes=cart.cart_level_discount_applications.map(item=>item.title);makeGraphQLRequest({query:this.discountQuery,variables},res=>{this.activeItems(res),index+1==discountCodes.length&&makeGraphQLRequest({query:this.discountQuery,variables:{cartId:`gid://shopify/Cart/${cart.token}`,discountCodes:[]}})})})}formatDate(inputDateString){const inputDate=new Date(inputDateString),day=String(inputDate.getDate()).padStart(2,"0"),month=String(inputDate.getMonth()+1).padStart(2,"0"),year=inputDate.getFullYear();return`${day}.${month}.${year}`}renderVoucherItem(voucher2){if(!voucher2.channelOnline)return"<span></span>";const item=this.voucherTemplate.content.querySelector(".voucher-item").cloneNode(!0);return item.querySelector("[data-description]").textContent=voucher2.description,item.querySelector("[data-discount-code]").value=voucher2.discountCode,item.querySelector("[data-end-date]").textContent=voucher2.endDate?`Hi\u1EC7u l\u1EF1c \u0111\u1EBFn h\u1EBFt ng\xE0y  ${this.formatDate(voucher2.endDate)}`:"",item.querySelector("[data-title]").textContent=voucher2.discountCode,item}checkCurrentDate(startDate,endDate){if(!endDate)return!0;let currentDate=new Date().getTime(),start=startDate?new Date(startDate).getTime():currentDate,end=endDate?new Date(endDate).getTime():currentDate;return currentDate<=end&&currentDate>=start}renderCustomerVouchers(data){if(data||this.customerVoucher){let customerVoucher=data||JSON.parse(this.customerVoucher.textContent);console.log(this.checkCurrentDate(voucher.startDate,voucher.endDate)),customerVoucher.forEach(voucher2=>{voucher2.discountStatus=="active"&&voucher2.channelOnline&&this.checkCurrentDate(voucher2.startDate,voucher2.endDate)&&this.querySelector(".voucher-list").appendChild(this.renderVoucherItem(voucher2))})}this.voucherItems=this.querySelectorAll(".voucher-item")}}customElements.define("checkout-voucher-list",CheckoutVoucherList);class MiddlePage extends HTMLElement{constructor(){super(),this.initialized=!1,this.form=this.querySelector("form"),this.inputElements=this.form.querySelectorAll(".field__input"),this.addressList=this.querySelector("#customerAddresses"),this.mainUrl=window.apiUrl,this.init(),this.cartBuyerIdentityQuery=`mutation cartBuyerIdentityUpdate($buyerIdentity: CartBuyerIdentityInput!, $cartId: ID!) {
      cartBuyerIdentityUpdate(buyerIdentity: $buyerIdentity, cartId: $cartId) {
        cart {
          buyerIdentity{
            email,
            phone,
            deliveryAddressPreferences {
              ... on MailingAddress {
                  address1
                  address2
                  city
                  company
                  country
                  firstName
                  lastName
                  phone
                  zip
              }
          }
          }
        }
        userErrors {
          field
          message
        }
      }
    }`,this.cartAttributesQuery=`mutation cartAttributesUpdate($attributes: [AttributeInput!]!, $cartId: ID!) {
      cartAttributesUpdate(attributes: $attributes, cartId: $cartId) {
        cart {
          checkoutUrl
        }
        userErrors {
          field
          message
        }
      }
    }
    `,this.createCheckoutQuery=`mutation checkoutCreate($input: CheckoutCreateInput!) {
      checkoutCreate(input: $input) {
        checkout {
          id
          webUrl
          orderStatusUrl
        }
        checkoutUserErrors {
          code
          field
          message
        }
        queueToken
      }
    }`,this.checkoutDiscountQuery=`mutation checkoutDiscountCodeApplyV2($checkoutId: ID!, $discountCode: String!) {
      checkoutDiscountCodeApplyV2(checkoutId: $checkoutId, discountCode: $discountCode) {
        checkout {
          id
          webUrl
          orderStatusUrl
        }
        checkoutUserErrors {
          code
          field
          message
        }
      }
    }
    `,Iodine.rule("phone",value=>/^[0-9\s+]+$/.test(value))}validateInput(input){let value=input.value;if(input.type=="tel"&&(value=input.value.replaceAll(" ","").replace("+84","0"),input.value=value),!input.dataset.rules||!input.dataset.messages)return!0;const errors=Iodine.assert(value,JSON.parse(input.dataset.rules),JSON.parse(input.dataset.messages));let label=document.getElementById(input.id+"-error");return label||(label=document.createElement("span"),label.id=input.id+"-error",label.classList.add("error"),input.closest(".field-input-wrapper").appendChild(label)),errors.valid?(input.classList.remove("is-valid"),label.textContent="",!0):(label.textContent=errors.error,input.classList.add("is-valid"),!1)}onsubmitHandler(e){e.preventDefault();const formData=new FormData(this.form);getCurrentCart(!0,cart=>{const cartId=cart.token,deliveryAddress={address1:`${formData.get("address[address1]")}, ${formData.get("address[address2_part2]")}, ${formData.get("address[address2_part1]")}`,address2:"",city:formData.get("address[city]"),company:"",country:"VN",firstName:formData.get("address[first_name]"),lastName:formData.get("address[last_name]"),zip:formData.get("address[zip]")};window.middlePageCustomer&&(deliveryAddress.phone=window.middlePageCustomer.phone);const cartBuyerVariables={buyerIdentity:{countryCode:"VN",deliveryAddressPreferences:[{deliveryAddress}]},cartId:`gid://shopify/Cart/${cartId}`};window.middlePageCustomer&&(cartBuyerVariables.buyerIdentity.phone=window.middlePageCustomer.phone,cartBuyerVariables.buyerIdentity.email=window.middlePageCustomer.email);const cartAttributesVariables={attributes:[{key:"firstName",value:formData.get("address[first_name]")},{key:"lastName",value:formData.get("address[last_name]")},{key:"province",value:formData.get("address[city]")},{key:"district",value:formData.get("address[address2_part1]")},{key:"ward",value:formData.get("address[address2_part2]")},{key:"street",value:formData.get("address[address1]")}],cartId:`gid://shopify/Cart/${cartId}`};document.body.classList.add("Loading"),document.querySelector("#PopupModal-middle-page-modal").hide(),makeGraphQLRequest({query:this.cartAttributesQuery,variables:cartAttributesVariables},()=>{makeGraphQLRequest({query:this.cartBuyerIdentityQuery,variables:cartBuyerVariables},({data,errors})=>{if(errors&&errors.length){alert("\u0110\xE3 x\u1EA3y ra s\u1EF1 c\u1ED1"),document.body.classList.remove("Loading");return}publish("levents:checkout");const{firstName,lastName,city,country,zip,address1}=deliveryAddress,query=[`checkout[shipping_address][first_name]=${firstName}`,`checkout[shipping_address][last_name]=${lastName}`,`checkout[shipping_address][address1]=${address1}`,`checkout[shipping_address][country]=${country}`,`checkout[shipping_address][city]=${city}`,`checkout[shipping_address][zip]=${zip}`];window.location.href=`/checkout?${query.join("&")}`,document.body.classList.remove("Loading")})})})}showConfirmPopup(e){e.preventDefault();const modal=document.querySelector("#PopupModal-middle-page-modal"),formData=new FormData(this.form);let isValid=Array.from(this.inputElements).map(this.validateInput),addonProduct=this.querySelector("addon-product");if(addonProduct&&addonProduct.productAdded&&isValid.push(addonProduct.checkIsValid()),isValid.includes(!1))return;let address={firstName:formData.get("address[first_name]"),lastName:formData.get("address[last_name]"),province:formData.get("address[city]"),district:formData.get("address[address2_part1]"),ward:formData.get("address[address2_part2]"),address:formData.get("address[address1]")};modal.querySelector('[name="fullname"]').value=`${address.lastName} ${address.firstName} `,modal.querySelector('[name="address"').value=`${address.address}, ${address.ward}, ${address.district}, ${address.province}`,modal.show()}updateFloatingLabels(){this.inputElements.forEach(inputElement=>{inputElement.addEventListener("input",()=>{let $fieldInputWrapper=inputElement.closest(".field-input-wrapper");inputElement.value.trim()!==""?$fieldInputWrapper.classList.add("field-show-floating"):$fieldInputWrapper.classList.remove("field-show-floating")})})}addInputEventListeners(){this.inputElements.forEach(inputElement=>{inputElement.addEventListener("change",this.handleOnAddressChange.bind(this))})}setInitialFloatingLabels(){this.inputElements.forEach(inputElement=>{let fieldElement=inputElement.closest(".field-input-wrapper");inputElement&&fieldElement&&(inputElement.tagName==="SELECT"||inputElement.value.trim()!=="")&&fieldElement.classList.add("field-show-floating")})}removeDuplicateObj(data,propName){const uniqueKeys=new Set;return data.filter(obj=>uniqueKeys.has(obj[propName])?!1:(uniqueKeys.add(obj[propName]),!0))}removeDuplicateItem(data){return[...new Set(data)]}clearSelect(selectEl,text){selectEl.innerHTML="",selectEl.innerHTML='<option value="">'+text+"</option>"}async loadCity(url,loadingElement){try{loadingElement.classList.add("loading");const resJson=await(await fetch(url,{method:"GET",redirect:"follow"})).json();return loadingElement.classList.remove("loading"),resJson.data}catch(err){return console.log(err),[]}}async loadDistrict(url,loadingElement){try{loadingElement.classList.add("loading");const resJson=await(await fetch(url,{method:"GET",redirect:"follow"})).json();return loadingElement.classList.remove("loading"),resJson.data}catch(err){return console.log(err),[]}}renderCity(form,listCity){let $global=this,selectCity=form.querySelector('select[name="address[city]"]'),selectDistrict=form.querySelector('select[name="address[address2_part1]"]'),selectWard=form.querySelector('select[name="address[address2_part2]"]'),inputZip=form.querySelector('input[name="address[zip]"]');this.sortCity(listCity).forEach(item=>{const option=document.createElement("option");option.id=item.code,option.value=item.name,option.textContent=item.name,option.setAttribute("data-zip",item.zip_code),selectCity.appendChild(option)}),selectCity.addEventListener("change",async function(e){e.preventDefault();const selectedOption2=this.selectedOptions[0],dataZip=selectedOption2.getAttribute("data-zip"),value=selectedOption2.value;inputZip.value=dataZip,$global.clearSelect(selectDistrict,"Ch\u1ECDn Qu\u1EADn/Huy\u1EC7n"),$global.clearSelect(selectWard,"Ch\u1ECDn Ph\u01B0\u1EDDng/X\xE3");let listDistrict=await $global.loadDistrict(`${$global.mainUrl}/locations/provinces?name=${value}`,form);if(listDistrict){let districtData=listDistrict.districts;$global.renderDistrict(form,districtData)}});let selectedOption=selectCity.querySelector(`option[value="${this.initForm.province||"0"}"]`);selectedOption&&(selectedOption.selected=!0,selectCity.dispatchEvent(new Event("change")))}renderDistrict(form,listDistricts){let $global=this,selectDistrict=form.querySelector('select[name="address[address2_part1]"]'),selectWard=form.querySelector('select[name="address[address2_part2]"]'),districtData=$global.sortDistrict(listDistricts);$global.clearSelect(selectDistrict,"Ch\u1ECDn Qu\u1EADn/Huy\u1EC7n"),districtData.forEach(item=>{const option=document.createElement("option");option.value=item.name,option.textContent=item.name,selectDistrict.appendChild(option)}),selectDistrict.addEventListener("change",function(e){e.preventDefault(),$global.clearSelect(selectWard,"Ch\u1ECDn Ph\u01B0\u1EDDng/X\xE3");const selectedDistrict=districtData.find(d=>d.name===this.value);if(selectedDistrict){let wards=selectedDistrict.wards;$global.renderWard(selectWard,wards)}});let selectedOption=selectDistrict.querySelector(`option[value="${this.initForm.district||"0"}"]`);selectedOption&&(selectedOption.selected=!0,selectDistrict.dispatchEvent(new Event("change")))}renderWard(selectWard,data){this.sortWard(data).forEach(item=>{const option=document.createElement("option");option.id=item.id,option.value=item.name,option.textContent=item.name,selectWard.appendChild(option)});let selectedOption=selectWard.querySelector(`option[value="${this.initForm.ward||"0"}"]`);selectedOption&&(selectedOption.selected=!0,selectWard.dispatchEvent(new Event("change")))}sortCity(data){let customSort=(a,b)=>{const order={"T\u1EC9nh/ Th\xE0nh Ph\u1ED1":0,"H\u1ED3 Ch\xED Minh":1,"H\xE0 N\u1ED9i":2},aIndex=order[a.name]!==void 0?order[a.name]:3,bIndex=order[b.name]!==void 0?order[b.name]:3;return aIndex!==bIndex?aIndex-bIndex:a.name.localeCompare(b.name)},processData=data.sort(customSort);return this.removeDuplicateObj(processData,"name")}sortDistrict(data){let customSort=(a,b)=>{const aIsQuan=a.name.startsWith("Qu\u1EADn"),bIsQuan=b.name.startsWith("Qu\u1EADn"),aIsHuyen=a.name.startsWith("Huy\u1EC7n"),bIsHuyen=b.name.startsWith("Huy\u1EC7n");if(aIsQuan&&!bIsQuan)return-1;if(!aIsQuan&&bIsQuan)return 1;if(aIsHuyen&&!bIsHuyen)return-1;if(!aIsHuyen&&bIsHuyen)return 1;if(aIsQuan&&bIsQuan){const aNameWithoutPrefix=a.name.replace("Qu\u1EADn ",""),bNameWithoutPrefix=b.name.replace("Qu\u1EADn ",""),aNumber=parseInt(aNameWithoutPrefix),bNumber=parseInt(bNameWithoutPrefix);if(!isNaN(aNumber)&&!isNaN(bNumber))return aNumber-bNumber;if(isNaN(aNumber)){if(!isNaN(bNumber))return 1}else return-1}return a.name.localeCompare(b.name)},processData=data.sort(customSort);return this.removeDuplicateObj(processData,"name")}sortWard(data){const customSort=(a,b)=>{const aIsPhuong=a.name.startsWith("Ph\u01B0\u1EDDng"),bIsPhuong=b.name.startsWith("Ph\u01B0\u1EDDng");if(aIsPhuong&&!bIsPhuong)return-1;if(!aIsPhuong&&bIsPhuong)return 1;if(aIsPhuong&&bIsPhuong){const aNameWithoutPrefix=a.name.replace("Ph\u01B0\u1EDDng ",""),bNameWithoutPrefix=b.name.replace("Ph\u01B0\u1EDDng ",""),aNumber=parseInt(aNameWithoutPrefix),bNumber=parseInt(bNameWithoutPrefix);if(!isNaN(aNumber)&&!isNaN(bNumber))return aNumber-bNumber;if(isNaN(aNumber)){if(!isNaN(bNumber))return 1}else return-1}return a.name.localeCompare(b.name)};return data.sort(customSort).filter((value,index,self)=>self.indexOf(value)===index)}getCustomerAddresses(){let addresses=this.querySelector("#addresses-json");this.addresses=addresses?JSON.parse(addresses.innerHTML):[]}getAddressObject(addressObj){let province=addressObj.city,district="",ward="",address="";if(addressObj.address1){let addressDetail=addressObj.address1.split(",");address=addressDetail[0]||"",ward=addressDetail[1]||"",district=addressDetail[2]||""}return{firstName:addressObj.first_name||"",lastName:addressObj.last_name||"",province,district:district.trim(),ward:ward.trim(),address:address.trim()}}compareAddress(address){return this.addresses.find(item=>{let itemAddress=item.address1.split(",").map(item2=>item2.trim()).join(", "),summary=` ${item.last_name} ${item.first_name},  ${itemAddress}, ${item.city}`,addressSummary=` ${address.lastName} ${address.firstName},  ${address.address}, ${address.ward}, ${address.district}, ${address.province}`;return summary==addressSummary})}handleOnAddressChange(e){if(this.validateInput(e.currentTarget),!this.addressList)return;if(e.currentTarget.id=="customerAddresses"){if(this.addresses.length>0){console.log(e.currentTarget.value);let defaultAddress=this.addresses.find(item=>item.id==e.currentTarget.value);defaultAddress?this.initForm=this.getAddressObject(defaultAddress):this.initForm={firstName:"",lastName:"",province:"",district:"",ward:"",address:""},this.handleOnAddressSelect()}return}const formData=new FormData(this.form);let address={firstName:formData.get("address[first_name]"),lastName:formData.get("address[last_name]"),province:formData.get("address[city]"),district:formData.get("address[address2_part1]"),ward:formData.get("address[address2_part2]"),address:formData.get("address[address1]")},selectedAddress=this.compareAddress(address);selectedAddress?this.addressList.value=selectedAddress.id:this.addressList.value=""}async handleOnAddressSelect(){const form=this.form;let listCity=await this.loadCity(`${this.mainUrl}/locations/provinces?onlyProvince=true`,form);this.renderCity(form,listCity),this.form.querySelector('[name="address[address1]"]').value=this.initForm.address||"",this.initForm.firstName&&(this.form.querySelector('[name="address[first_name]"]').value=this.initForm.firstName||""),this.initForm.lastName&&(this.form.querySelector('[name="address[last_name]"]').value=this.initForm.lastName||""),this.inputElements.forEach(inputElement=>{let $fieldInputWrapper=inputElement.closest(".field-input-wrapper");$fieldInputWrapper&&inputElement.value.trim()!==""&&$fieldInputWrapper.classList.add("field-show-floating")})}async init(){this.setInitialFloatingLabels(),this.getCustomerAddresses(),this.updateFloatingLabels(),this.addInputEventListeners(),this.form.addEventListener("submit",this.showConfirmPopup.bind(this)),this.querySelectorAll(".submit-middle-page-btn").forEach(button=>button.addEventListener("click",e=>{this.showConfirmPopup(e)})),document.querySelectorAll(".submit-checkout-btn").forEach(button=>button.addEventListener("click",e=>{this.onsubmitHandler(e)})),getCurrentCart(!1,async cart=>{if(this.cartId=cart.token,this.initForm={...cart.attributes},console.log(this.initForm),!this.initForm.province&&this.addresses.length>0){let defaultAddress=this.addresses.find(item=>item.default);defaultAddress&&(this.initForm=this.getAddressObject(defaultAddress))}this.handleOnAddressSelect()})}}customElements.define("middle-page",MiddlePage);
//# sourceMappingURL=/cdn/shop/t/8/assets/middle-page.js.map?v=18070243987939137001735013605
